<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mission Locale Runner</title>
    <style>
        :root {
            --primary: #0d47a1;
            --accent: #ffca28;
            --sky: #87CEEB;
        }

        /* RESET TOTAL POUR BLOQUER LE SCROLL */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* EmpÃªche de monter/descendre */
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed; /* Bloque la page sur iOS */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 56.25vw; /* Ratio 16/9 automatique */
            max-height: 100vh;
            max-width: 177.78vh; /* Garde le ratio mÃªme sur grand Ã©cran */
            background: var(--sky);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
            touch-action: none; /* EmpÃªche le scroll tactile */
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 100;
            text-align: center;
        }

        /* Style des boutons */
        .btn {
            background: var(--accent);
            border: none;
            padding: 15px 40px;
            font-size: clamp(16px, 4vw, 24px);
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #c79100;
        }

        .qcm-btn {
            width: 90%;
            max-width: 500px;
            padding: 10px;
            margin: 5px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #fff;
            font-size: clamp(14px, 3vw, 18px);
        }

        #rotate-notice {
            display: none;
            background: var(--primary);
            color: white;
            z-index: 999;
        }

        @media (orientation: portrait) {
            #rotate-notice { display: flex; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="menu" class="overlay">
        <h1 style="color:var(--primary); margin:0; font-size: clamp(20px, 5vw, 32px);">Mission Locale Runner</h1>
        <p>Ã‰vite les obstacles !</p>
        <button id="startBtn" class="btn">JOUER</button>
        <p id="bestScore" style="font-weight:bold; margin-top:10px;"></p>
    </div>

    <div id="questionScreen" class="overlay" style="display:none">
        <h2 id="qText" style="font-size: 1.2rem;">Question</h2>
        <div id="qOptions" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    </div>

    <div id="countdown" class="overlay" style="display:none; font-size:80px; font-weight:bold; background:transparent;">3</div>

    <div id="rotate-notice" class="overlay">
        <h2>ðŸ“± Tournez l'Ã©cran</h2>
        <p>Le jeu se joue en paysage.</p>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const menu = document.getElementById('menu');
    const startBtn = document.getElementById('startBtn');
    
    let state = 'MENU';
    let score = 0;
    let highscore = localStorage.getItem('ml_highscore') || 0;
    let player = { x: 80, y: 0, r: 20, vy: 0, jumps: 0 };
    let obstacles = [];
    let speed = 5;

    const QUESTIONS = [
        {q:"Un CV doit Ãªtre...", c:["Long","Clair et structurÃ©","Secret"], a:1},
        {q:"La Mission Locale aide les...", c:["16-25 ans","SÃ©niors","Enfants"], a:0},
        {q:"Arriver Ã  l'heure est...", c:["Inutile","Essentiel","Optionnel"], a:1}
    ];

    function init() {
        canvas.width = 800;
        canvas.height = 450;
        player.y = canvas.height - 60;
        document.getElementById('bestScore').textContent = `Record : ${highscore}`;
    }

    // GESTION DU CLIC/TOUCHER
    function handleJump(e) {
        if(e) e.preventDefault();
        if (state === 'PLAY' && player.jumps < 2) {
            player.vy = -14;
            player.jumps++;
        }
    }

    startBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        startGame();
    });

    canvas.addEventListener('touchstart', handleJump, {passive: false});
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') handleJump(); });

    function startGame() {
        state = 'PLAY';
        menu.style.display = 'none';
        score = 0;
        speed = 5;
        obstacles = [];
        player.y = canvas.height - 60;
        player.vy = 0;
        player.jumps = 0;
    }

    function triggerGameOver() {
        state = 'QUESTION';
        const questionScreen = document.getElementById('questionScreen');
        questionScreen.style.display = 'flex';
        const q = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
        
        document.getElementById('qText').textContent = q.q;
        const optionsDiv = document.getElementById('qOptions');
        optionsDiv.innerHTML = '';

        q.c.forEach((choice, i) => {
            const btn = document.createElement('button');
            btn.className = 'qcm-btn';
            btn.textContent = choice;
            btn.onclick = () => {
                if (i === q.a) {
                    questionScreen.style.display = 'none';
                    state = 'PLAY';
                    obstacles = [];
                    player.vy = 0;
                } else {
                    location.reload(); // Recommence tout
                }
            };
            optionsDiv.appendChild(btn);
        });
    }

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Sol
        ctx.fillStyle = "#4CAF50";
        ctx.fillRect(0, canvas.height - 40, canvas.width, 40);

        if (state === 'PLAY') {
            score++;
            player.vy += 0.8;
            player.y += player.vy;

            if (player.y > canvas.height - 60) {
                player.y = canvas.height - 60;
                player.jumps = 0;
            }

            if (score % 120 === 0) {
                obstacles.push({ x: canvas.width, y: canvas.height - 70, w: 30, h: 30 });
            }

            obstacles.forEach((o, i) => {
                o.x -= speed;
                ctx.fillStyle = "#FF5722";
                ctx.fillRect(o.x, o.y, o.w, o.h);

                if (player.x + 15 > o.x && player.x - 15 < o.x + o.w && player.y + 15 > o.y) {
                    triggerGameOver();
                }
            });
            obstacles = obstacles.filter(o => o.x > -50);
        }

        // Joueur
        ctx.fillStyle = "#ffca28";
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
        ctx.fill();

        requestAnimationFrame(update);
    }

    init();
    update();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mission Locale Runner - Pro</title>
    <style>
        :root {
            --primary: #0d47a1;
            --accent: #ffca28;
            --sky: #87CEEB;
            --ground: #4CAF50;
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            margin: 0; padding: 0;
            background: #000;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: var(--sky);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        canvas { width: 100%; height: 100%; display: block; }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; padding: 20px;
            z-index: 100;
        }

        h1 { color: var(--primary); margin: 0 0 15px; font-size: 28px; }
        p { color: #444; margin-bottom: 20px; line-height: 1.4; }

        .btn {
            background: var(--accent);
            color: #333;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #c79100;
            transition: all 0.1s;
        }

        .btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #c79100;
        }

        .qcm-btn {
            width: 100%;
            max-width: 450px;
            padding: 12px 20px;
            margin: 8px 0;
            font-size: 16px;
            text-align: left;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
        }

        .qcm-btn:hover { background: #e0e0e0; }

        #countdown {
            font-size: 120px;
            font-weight: 900;
            color: var(--primary);
            pointer-events: none;
            background: transparent;
        }

        #rotate-notice {
            display: none;
            background: var(--primary);
            color: white;
            z-index: 999;
        }

        @media (orientation: portrait) {
            #rotate-notice { display: flex; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="menu" class="overlay">
        <h1>Mission Locale Runner</h1>
        <p>√âvitez les obstacles pour aller le plus loin possible.<br>
           En cas de choc, r√©pondez bien pour continuer !</p>
        <button id="startBtn" class="btn">JOUER</button>
        <p id="bestScore" style="margin-top:20px; font-weight:bold;"></p>
    </div>

    <div id="questionScreen" class="overlay" style="display:none">
        <h2 id="qText">Question ?</h2>
        <div id="qOptions" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    </div>

    <div id="countdown" class="overlay" style="display:none">3</div>

    <div id="rotate-notice" class="overlay">
        <h1>üì± Tournez l'√©cran</h1>
        <p>Le jeu n√©cessite le mode paysage.</p>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const menu = document.getElementById('menu');
    const startBtn = document.getElementById('startBtn');
    const questionScreen = document.getElementById('questionScreen');
    const countdownScreen = document.getElementById('countdown');

    // --- Configuration du Jeu ---
    let state = 'MENU';
    let score = 0;
    let highscore = localStorage.getItem('ml_highscore') || 0;
    let speed = 5;
    let gameFrame = 0;

    const player = {
        x: 80, y: 0, r: 25, 
        vy: 0, gravity: 0.8, 
        jumpForce: -15, jumps: 0,
        groundY: 0
    };

    let obstacles = [];
    let clouds = [];

    const QUESTIONS = [
        {q:"Le CV doit √™tre de pr√©f√©rence...", c:["Sur 10 pages","Clair et sur 1 page","√âcrit √† la main"], a:1},
        {q:"La ponctualit√© en entreprise est...", c:["Facultative","Essentielle","Pour les chefs"], a:1},
        {q:"Un soft-skill, c'est quoi ?", c:["Une comp√©tence technique","Une qualit√© humaine","Un logiciel"], a:1},
        {q:"La Mission Locale aide les jeunes de...", c:["16 √† 25 ans","40 √† 50 ans","5 √† 10 ans"], a:0},
        {q:"Que faire avant un entretien ?", c:["Dormir sur place","Se renseigner sur l'entreprise","Rien"], a:1}
    ];

    function init() {
        canvas.width = 800;
        canvas.height = 450;
        player.groundY = canvas.height - 60;
        player.y = player.groundY;
        document.getElementById('bestScore').textContent = `Record : ${highscore}`;
    }

    // --- Gestion des entr√©es ---
    function handleJump() {
        if (state === 'PLAY' && player.jumps < 2) {
            player.vy = player.jumpForce;
            player.jumps++;
        }
    }

    // Fix pour le bouton qui ne marche pas : on s√©pare les clics
    startBtn.onclick = (e) => {
        e.stopPropagation();
        startGame();
    };

    window.addEventListener('keydown', (e) => { if(e.code === 'Space') handleJump(); });
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleJump(); }, {passive: false});

    function startGame() {
        state = 'PLAY';
        menu.style.display = 'none';
        score = 0;
        speed = 5;
        obstacles = [];
        player.jumps = 0;
        player.vy = 0;
        player.y = player.groundY;
        
        // Init nuages
        clouds = Array.from({length: 5}, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * 100 + 50,
            s: Math.random() * 1 + 0.5
        }));
    }

    function triggerGameOver() {
        state = 'QUESTION';
        questionScreen.style.display = 'flex';
        const q = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
        
        document.getElementById('qText').textContent = q.q;
        const optionsDiv = document.getElementById('qOptions');
        optionsDiv.innerHTML = '';

        q.c.forEach((choice, i) => {
            const btn = document.createElement('button');
            btn.className = 'qcm-btn';
            btn.textContent = choice;
            btn.onclick = () => {
                if (i === q.a) {
                    resumeGame();
                } else {
                    endGame();
                }
            };
            optionsDiv.appendChild(btn);
        });
    }

    function resumeGame() {
        questionScreen.style.display = 'none';
        countdownScreen.style.display = 'flex';
        let count = 3;
        countdownScreen.textContent = count;
        
        const timer = setInterval(() => {
            count--;
            if (count <= 0) {
                clearInterval(timer);
                countdownScreen.style.display = 'none';
                state = 'PLAY';
                obstacles = []; // Nettoie le passage
            } else {
                countdownScreen.textContent = count;
            }
        }, 800);
    }

    function endGame() {
        if (score > highscore) {
            highscore = score;
            localStorage.setItem('ml_highscore', highscore);
        }
        state = 'MENU';
        questionScreen.style.display = 'none';
        menu.style.display = 'flex';
        init();
    }

    // --- Boucle de rendu ---
    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Dessin Nuages
        ctx.fillStyle = "white";
        clouds.forEach(c => {
            if (state === 'PLAY') c.x -= c.s;
            if (c.x < -100) c.x = canvas.width + 50;
            ctx.beginPath();
            ctx.arc(c.x, c.y, 20, 0, Math.PI*2);
            ctx.fill();
        });

        // Dessin Sol
        ctx.fillStyle = varColor('--ground');
        ctx.fillRect(0, player.groundY + player.r, canvas.width, 100);

        if (state === 'PLAY') {
            gameFrame++;
            score++;
            if (score % 500 === 0) speed += 0.5;

            // Physique Joueur
            player.vy += player.gravity;
            player.y += player.vy;
            if (player.y > player.groundY) {
                player.y = player.groundY;
                player.vy = 0;
                player.jumps = 0;
            }

            // Gestion Obstacles
            if (gameFrame % 100 === 0) {
                obstacles.push({
                    x: canvas.width + 50,
                    y: player.groundY + 5,
                    w: 30, h: 40
                });
            }

            obstacles.forEach((o, i) => {
                o.x -= speed;
                ctx.fillStyle = "#d32f2f";
                ctx.fillRect(o.x, o.y, o.w, o.h);

                // Collision simple
                if (player.x + 15 > o.x && player.x - 15 < o.x + o.w &&
                    player.y + 15 > o.y) {
                    triggerGameOver();
                }
            });
            obstacles = obstacles.filter(o => o.x > -100);
        }

        // Dessin Joueur
        ctx.fillStyle = varColor('--accent');
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = varColor('--primary');
        ctx.lineWidth = 4;
        ctx.stroke();
        
        // HUD
        if (state === 'PLAY') {
            ctx.fillStyle = varColor('--primary');
            ctx.font = "bold 20px sans-serif";
            ctx.fillText(`SCORE: ${score}`, 20, 40);
        }

        requestAnimationFrame(update);
    }

    function varColor(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    init();
    update();
</script>

</body>
</html>

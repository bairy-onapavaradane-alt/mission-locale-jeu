<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mission Locale Runner - Final</title>
    <style>
        :root {
            --primary: #0d47a1;
            --accent: #ffca28;
            --sky: #e3f2fd;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            font-family: sans-serif;
        }

        #game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            /* Magie du centrage : conserve le ratio sans jamais d√©passer */
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            background: var(--sky);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border-radius: 8px;
        }

        .overlay {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100;
            padding: 20px;
        }

        .btn {
            background: var(--accent);
            color: var(--primary);
            border: none;
            padding: 15px 40px;
            font-size: 22px;
            font-weight: 900;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #c79100;
        }

        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #c79100; }

        .qcm-btn {
            width: 85%;
            max-width: 400px;
            padding: 12px;
            margin: 6px;
            border: 2px solid var(--primary);
            background: white;
            font-weight: bold;
            border-radius: 10px;
        }

        #rotate-notice {
            display: none;
            background: var(--primary);
            color: white;
            z-index: 999;
        }

        @media (orientation: portrait) {
            #rotate-notice { display: flex; }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="menu" class="overlay">
        <h1 style="color:var(--primary); margin:0 0 10px 0;">Mission Locale Runner</h1>
        <p style="margin-bottom: 20px;">Saute pour √©viter les obstacles !</p>
        <button id="startBtn" class="btn">JOUER</button>
        <p id="bestScore" style="margin-top: 15px; font-size: 14px; color: #666;"></p>
    </div>

    <div id="questionScreen" class="overlay" style="display:none">
        <h2 id="qText" style="color:var(--primary); font-size: 1.2rem;">Question</h2>
        <div id="qOptions" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    </div>

    <div id="rotate-notice" class="overlay">
        <h2>üì± Tournez votre t√©l√©phone</h2>
        <p>Le jeu n√©cessite le mode paysage.</p>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- Config Canvas Stable ---
    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 400;
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    let state = 'MENU';
    let score = 0;
    let highscore = localStorage.getItem('ml_highscore_v3') || 0;
    let speed = 6;
    let gameFrame = 0;

    const player = {
        x: 100,
        y: GAME_HEIGHT - 80,
        r: 25,
        vy: 0,
        gravity: 0.8,
        jumpForce: -15,
        jumps: 0,
        groundY: GAME_HEIGHT - 80
    };

    let obstacles = [];

    const QUESTIONS = [
        {q:"Quel √¢ge faut-il avoir pour la Mission Locale ?", c:["10-15 ans","16-25 ans","30-50 ans"], a:1},
        {q:"Le CV doit-il √™tre obligatoirement en couleur ?", c:["Oui","Non, mais il doit √™tre clair","Seulement pour les artistes"], a:1},
        {q:"Que signifie l'autonomie ?", c:["Travailler seul sans aide","Savoir s'organiser et demander si besoin","Ne jamais parler"], a:1},
        {q:"La ponctualit√© c'est...", c:["Arriver 5 min apr√®s l'heure","Arriver √† l'heure ou un peu avant","Arriver quand on peut"], a:1}
    ];

    function startGame() {
        state = 'PLAY';
        document.getElementById('menu').style.display = 'none';
        score = 0;
        speed = 6;
        obstacles = [];
        player.y = player.groundY;
        player.vy = 0;
        player.jumps = 0;
        gameFrame = 0;
    }

    function handleInput(e) {
        if(e) e.preventDefault();
        if (state === 'PLAY' && player.jumps < 2) {
            player.vy = player.jumpForce;
            player.jumps++;
        }
    }

    document.getElementById('startBtn').onclick = (e) => { e.stopPropagation(); startGame(); };
    canvas.addEventListener('touchstart', handleInput, {passive: false});
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') handleInput(); });

    function triggerGameOver() {
        state = 'QUESTION';
        const screen = document.getElementById('questionScreen');
        screen.style.display = 'flex';
        const q = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
        
        document.getElementById('qText').textContent = q.q;
        const opts = document.getElementById('qOptions');
        opts.innerHTML = '';

        q.c.forEach((choice, i) => {
            const btn = document.createElement('button');
            btn.className = 'qcm-btn';
            btn.textContent = choice;
            btn.onclick = () => {
                if (i === q.a) {
                    screen.style.display = 'none';
                    state = 'PLAY';
                    obstacles = [];
                    player.vy = 0;
                } else {
                    if(score > highscore) localStorage.setItem('ml_highscore_v3', score);
                    location.reload();
                }
            };
            opts.appendChild(btn);
        });
    }

    function drawPlayer() {
        ctx.save();
        ctx.translate(player.x, player.y);
        
        // Cercle ext√©rieur Bleu
        ctx.beginPath();
        ctx.arc(0, 0, player.r, 0, Math.PI * 2);
        ctx.fillStyle = "#0d47a1";
        ctx.fill();
        
        // Cercle int√©rieur Jaune
        ctx.beginPath();
        ctx.arc(0, 0, player.r - 5, 0, Math.PI * 2);
        ctx.fillStyle = "#ffca28";
        ctx.fill();

        // Texte MLE
        ctx.fillStyle = "#0d47a1";
        ctx.font = "bold 15px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("MLE", 0, 1);
        ctx.restore();
    }

    function update() {
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

        // Dessin
